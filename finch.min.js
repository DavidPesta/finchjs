/*
	Finch.js - Hierarchical Javascript Routing
	by Rick Allen (stoodder) and Greg Smith (smrq)

	Version 1.0.0
	Full source at https://github.com/stoodder/finchjs
	Copyright (c) 2014 RokkinCat, http://www.rokkincat.com

	MIT License, https://github.com/stoodder/finchjs/blob/master/LICENSE.md
*/
(function(){var t,n,e,r,o,i,s,a,u,p,l,h,c,f,d,_,g,m=[].slice,y={}.hasOwnProperty,b=function(t,n){function e(){this.constructor=t}for(var r in n)y.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},w=[].indexOf||function(t){for(var n=0,e=this.length;e>n;n++)if(n in this&&this[n]===t)return n;return-1};e=function(t){var n,e,r,o,i;for(e={},o=0,i=t.length;i>o;o++)n=t[o],e[n]=!0;return function(){var t;t=[];for(n in e)r=e[n],t.push(n);return t}()},n=function(t,n){var e,r,o,i;if(!s(t))return[];for(s(n)||(n=[n]),r=0,i=n.length;i>r;r++)e=n[r],t=function(){var n,r,i;for(i=[],n=0,r=t.length;r>n;n++)o=t[n],o!==e&&i.push(o);return i}();return t},c=function(t){return null!=t&&"[object Object]"===Object.prototype.toString.call(t)},p=function(t){return null!=t&&"[object Function]"===Object.prototype.toString.call(t)},a=function(t){return null!=t&&"[object Boolean]"===Object.prototype.toString.call(t)},s=function(t){return null!=t&&"[object Array]"===Object.prototype.toString.call(t)},f=function(t){return null!=t&&"[object String]"===Object.prototype.toString.call(t)},h=function(t){return null!=t&&"[object Number]"===Object.prototype.toString.call(t)},l=function(t){return h(t)&&t!==t},u=function(t){var n,e;if(null==t)return!0;if(f(t))return 0===_(t).length;if(s(t))return 0===t.length;if(c(t)){for(n in t)return e=t[n],!1;return!0}return!1},_=String.prototype.trim?function(t){return String.prototype.trim.call(t)}:function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")},g=function(t){return t.replace(/^[\\/\s]+/,"").replace(/[\\/\s]+$/,"")},d=function(t,n){return 0===t.indexOf(n)},o=function(t,n){return t.lastIndexOf(n)===t.length-1},r=function(t,n){return t.split(n).length-1},t=function(){function t(){this.tree=new t.Tree}return t.prototype.tree=null,t.prototype.__run__=function(n,e){var r;try{return e.call(this)}catch(o){if(r=o,!(r instanceof t.Error))throw r;r instanceof t.NotFoundError?this.trigger("not_found",r):this.trigger("error",r)}return n},t.prototype.route=function(t,n){return this.__run__(this,function(){var e;return e=this.tree.addRoute(t),e.setCallbacks(n),this})},t.prototype.call=function(t){return this.__run__(this,function(){return this.tree.callRoute(t),this})},t.prototype.reload=function(){return this.__run__(this,function(){return this.tree.load_path.reload(),this})},t.prototype.peek=function(){return this.__run__(null,function(){return""})},t.prototype.observe=function(){var n;return n=1<=arguments.length?m.call(arguments,0):[],this.__run__(null,function(){var e;return e=function(t,n,e){e.prototype=t.prototype;var r=new e,o=t.apply(r,n);return Object(o)===o?o:r}(t.Observer.create,n,function(){}),this.tree.load_path.addObserver(e),e})},t.prototype.abort=function(){return this.__run__(this,function(){return this.tree.load_path.abort(),this})},t.prototype.listen=function(){return this.__run__(!1,function(){return t.UriManager.listen()})},t.prototype.ignore=function(){return this.__run__(!1,function(){return t.UriManager.ignore()})},t.prototype.navigate=function(n,e,r){return this.__run__(this,function(){return t.UriManager.navigate(n,e,r),this})},t.prototype.reset=function(){return this.__run__(this,function(){return this.tree.load_path.abort(),this.tree=new t.Tree,this})},t.prototype.options=function(t,n){return this.__run__(this,function(){var e,r;if(c(t)){for(e in t)r=t[e],this.options(e,r);return this}switch(t){case"coerce_types":case"CoerceParameterTypes":this.tree.load_path.coerce_types=n}return this})},t.prototype.on=function(){},t.prototype.off=function(){},t.prototype.trigger=function(){},t}(),t.Error=function(){function t(t){this.message=t}return t.prototype.name="Finch.Error",t.prototype.message=null,t.prototype.toString=function(){return""+this.name+": "+this.message},t}(),t.Console=new(function(){function t(){}return t.prototype.log=function(){},t.prototype.error=function(){},t.prototype.warn=function(){},t}()),t.LoadPath=function(){function n(n,e,r){var o,i,a,u,p;if(null==n&&(n=[]),null==e&&(e=[]),!s(n))throw new t.Error("nodes must be an Array");if(!s(e))throw new t.Error("route_components must be an Array");for(u=0,p=n.length;p>u;u++)if(i=n[u],!(i instanceof t.Node))throw new t.Error("nodes must be an instanceof Finch.Node");if(n.length!==e.length)throw new t.Error("nodes and route_components must have the same lengths");this.nodes=n,this.route_components=e,this.length=this.nodes.length,this.bindings={},this.observers=[],c(r)||(r={}),this.params={};for(o in r)a=r[o],this.params[o]=a}return n.prototype.nodes=null,n.prototype.route_components=null,n.prototype.length=0,n.prototype.is_traversing=!1,n.prototype.current_operation_queue=null,n.prototype.bindings=null,n.prototype.observers=null,n.prototype.params=null,n.prototype.coerce_types=!1,n.prototype.abort=function(){return this.current_operation_queue instanceof t.OperationQueue&&(this.current_operation_queue.abort(),this.current_operation_queue=null),this},n.prototype.push=function(n,e){var r;if(!(n instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");if(!f(e))throw new t.Error("route_component must be a string");return this.nodes.push(n),this.route_components.push(e),this.observers.push([]),this.length++,n.type===t.Node.VARIABLE&&(r=n.name.slice(1),this.bindings[r]=e),this},n.prototype.pushUntil=function(n,e){var r,o,i,s,a,u,p,l,h;if(!(n instanceof t.LoadPath))throw new Error("target_load_path must be an instanceof Finch.LoadPath");if(!(e instanceof t.Node))throw new Error("target_node must be an instanceof Finch.Node");if(r=this.length,o=n.indexFor(e)+1,r>=o)return this;for(a=n.nodes.slice(r,o),p=n.route_components.slice(r,o),i=l=0,h=a.length;h>l;i=++l)s=a[i],u=p[i],this.push(s,u);return this},n.prototype.pop=function(n){var e,r;return this.length>0?(n=this.nodes.pop(),r=this.route_components.pop(),this.observers.pop(),this.length--,this.length<=0?this.bindings={}:n.type===t.Node.VARIABLE&&(e=n.name.slice(1),this.bindings[e]=void 0,delete this.bindings[e]),[n,r]):null},n.prototype.popUntil=function(n){if(!(null===n||n instanceof t.Node))throw new t.Error("target_node must be an instanceof Finch.Node");for(;this.length>0&&this.nodes[this.length-1]!==n;)this.pop();return this},n.prototype.indexFor=function(n){var e,r,o,i,s;if(!(n instanceof t.Node))return-1;for(s=this.nodes,e=o=0,i=s.length;i>o;e=++o)if(r=s[e],r===n)return e;return-1},n.prototype.nodeAt=function(t){return t>=0&&t<this.length?this.nodes[t]:null},n.prototype.prepareParams=function(t){var n,e,r,o,i;this.params=null!=t?t:this.params,e={},o=this.params;for(n in o)r=o[n],e[n]=r;i=this.bindings;for(n in i)r=i[n],e[n]=r;return this.coerceObject(e)},n.prototype.coerceObject=function(t){var n,e,r;if(!this.coerce_types)return t;e={};for(n in t)r=t[n],e[n]="true"===r?!0:"false"===r?!1:/^[0-9]+$/.test(r)?parseInt(r):/^[0-9]+\.[0-9]*$/.test(r)?parseFloat(r):r;return e},n.prototype.createOperationQueue=function(){return new t.OperationQueue({before_start:function(t){return function(){return t.is_traversing=!0}}(this),after_finish:function(t){return function(n){return t.is_traversing=!1,t.current_operation_queue=null,n?void 0:t.notifyObservers()}}(this)})},n.prototype.reload=function(){var n;return this.length<=0?this:(n=this.nodeAt(this.length-1),null==this.current_operation_queue&&(this.current_operation_queue=this.createOperationQueue()),this.current_operation_queue.appendOperation(t.Operation.UNLOAD,n,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),this.current_operation_queue.appendOperation(t.Operation.LOAD,n,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),this.current_operation_queue.execute(),this)},n.prototype.traverseTo=function(n){var e,r,o,i,s;if(!(n instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");if(this.routesAreEqual(n))return this.paramsAreEqual(n)?this:(this.params=n.params,null!=this.current_operation_queue?this:(this.notifyObservers(),this));if(e=this.findCommonAncestor(n),i=this.nodeAt(this.length-1),o=n.nodeAt(n.length-1),null==this.current_operation_queue&&(this.current_operation_queue=this.createOperationQueue()),i instanceof t.Node&&o instanceof t.Node)if(i===o)this.current_operation_queue.appendOperation(t.Operation.UNLOAD,i,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(){return t.popUntil(e)}}(this)}),this.current_operation_queue.appendOperation(t.Operation.LOAD,o,{before_step:function(t){return function(){return t.pushUntil(n,o)}}(this),setup_params:function(t){return function(){return t.prepareParams(n.params)}}(this)});else{for(this.current_operation_queue.appendOperation(t.Operation.UNLOAD,i,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),r=i;r!==e;)this.current_operation_queue.appendOperation(t.Operation.TEARDOWN,r,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(n,e){return t.popUntil(e.parent)}}(this)}),r=r.parent;for(s=[],r=o;r instanceof t.Node&&r!==e;)s.push(r),r=r.parent;for(;r=s.pop();)this.current_operation_queue.appendOperation(t.Operation.SETUP,r,{before_step:function(t){return function(e,r){return t.pushUntil(n,r)}}(this),setup_params:function(t){return function(){return t.prepareParams(n.params)}}(this)});this.current_operation_queue.appendOperation(t.Operation.LOAD,o,{setup_params:function(t){return function(){return t.prepareParams(n.params)}}(this)})}else if(o instanceof t.Node){for(s=[],r=o;r instanceof t.Node&&r!==e;)s.push(r),r=r.parent;for(;r=s.pop();)this.current_operation_queue.appendOperation(t.Operation.SETUP,r,{before_step:function(t){return function(e,r){return t.pushUntil(n,r)}}(this),setup_params:function(t){return function(){return t.prepareParams(n.params)}}(this)});this.current_operation_queue.appendOperation(t.Operation.LOAD,o,{setup_params:function(t){return function(){return t.prepareParams(n.params)}}(this)})}else if(i instanceof t.Node)for(this.current_operation_queue.appendOperation(t.Operation.UNLOAD,i,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),r=i;r!==e;)this.current_operation_queue.appendOperation(t.Operation.TEARDOWN,r,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(n,e){return t.popUntil(e.parent)}}(this)}),r=r.parent;return this.current_operation_queue.execute(),this},n.prototype.findCommonAncestor=function(n){var e,r,o,i,s,a,u,p,l,h,c;if(!(n instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");for(o=this.nodes[this.length-1],u=n.nodes[n.length-1],e=null,i=[];o instanceof t.Node;)i.unshift(o),o=o.parent;for(p=[];u instanceof t.Node;)p.unshift(u),u=u.parent;for(a=h=0,c=i.length;c>h;a=++h){if(o=i[a],u=p[a],o!==u)return e;if(r=this.indexFor(u),s=this.route_components.slice(0,r+1).join("/"),l=n.route_components.slice(0,r+1).join("/"),s!==l)return e;e=o}return e},n.prototype.routesAreEqual=function(n){var e,r,o,i,s,a;if(!(n instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");if(this.length!==n.length)return!1;for(a=this.route_components,e=i=0,s=a.length;s>i;e=++i)if(r=a[e],o=n.route_components[e],r!==o)return!1;return!0},n.prototype.paramsAreEqual=function(n){var e,r,o,i,s,a,u,p;if(!(n instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");r=0,a=this.params;for(e in a)s=a[e],r++;o=0,u=n.params;for(e in u)s=u[e],o++;if(r!==o)return!1;p=this.params;for(e in p){if(s=p[e],void 0===(i=n.params[e]))return!1;if(i!==s)return!1}return!0},n.prototype.addObserver=function(t){return this.length>0&&this.nodes[this.length-1].should_observe?(this.observers[this.length-1].push(t),t):t},n.prototype.notifyObservers=function(){var t,n,e,r,o,i,s,a,u;for(u=this.observers,t=o=0,s=u.length;s>o;t=++o){for(r=u[t],n=[],i=0,a=r.length;a>i;i++)e=r[i],e.is_disposed||(e.notify(this.coerceObject(this.params)),n.push(e));this.observers[t]=n}return this},n.prototype.toString=function(){var t,n,e,r;return e=this.route_components.join("/"),n=function(){var n,e;n=this.params,e=[];for(t in n)r=n[t],e.push(""+t+"="+r);return e}.call(this).join("&"),n.length>0&&(e+="?"+n),e},n}(),t.Node=function(){function n(n,e){this.name=n,this.type=t.Node.resolveType(this.name),this.parent=null!=e?e:null,this.params={},this.context={}}var e,r;return n.LITERAL="literal",n.VARIABLE="variable",e=[n.LITERAL,n.VARIABLE],r=/^:[a-z0-9_-]+$/i,n.resolveType=function(n){return new RegExp(r).test(n)?t.Node.VARIABLE:t.Node.LITERAL},n.prototype.type=null,n.prototype.name=null,n.prototype.parent=null,n.prototype.params=null,n.prototype.literal_children=null,n.prototype.variable_child=null,n.prototype.should_observe=!0,n.prototype.is_endpoint=!1,n.prototype.setup_callback=null,n.prototype.load_callback=null,n.prototype.unload_callback=null,n.prototype.teardown_callback=null,n.prototype.generalized_callback=null,n.prototype.addChildNode=function(n){if(!(n instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");if(n.type===t.Node.VARIABLE)this.variable_child=n;else{if(null==this.literal_children&&(this.literal_children={}),this.literal_children[n.name])throw new t.Error("A node with the name '"+n.name+"' is already a child of the node '"+this.name+"'");this.literal_children[n.name]=n}return this},n.prototype.findChildNode=function(n){var e,r,o;if(!f(n))throw new t.Error("name must be a String");return r=t.Node.resolveType(n),e=r===t.Node.VARIABLE?this.variable_child:null!=(o=this.literal_children)?o[n]:void 0,null!=e?e:null},n.prototype.findMatchingChildNode=function(n){var e,r,o;if(!f(n))throw new t.Error("component must be a String");return null!=(e=null!=(r=null!=(o=this.literal_children)?o[n]:void 0)?r:this.variable_child)?e:null},n.prototype.setParentNode=function(n){if(!(null===n||n instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");return this.parent=n,this},n.prototype.setCallbacks=function(t){return p(t)?(this.generalized_callback=t,this.setup_callback=this.load_callback=this.unload_callback=this.teardown_callback=null):c(t)&&(this.generalized_callback=null,this.setup_callback=p(t.setup)?t.setup:function(){},this.load_callback=p(t.load)?t.load:function(){},this.unload_callback=p(t.unload)?t.unload:function(){},this.teardown_callback=p(t.teardown)?t.teardown:function(){}),this},n.prototype.getCallback=function(n,e,r){var o,i;if(p(this.generalized_callback)){if(n===t.Operation.UNLOAD)return function(){};if(n===t.Operation.TEARDOWN)return function(){};if(e===t.Operation.SETUP&&r===this)return function(){};o=this.generalized_callback,this.should_observe=n===t.Operation.SETUP}else o=function(){switch(n){case t.Operation.SETUP:return this.setup_callback;case t.Operation.LOAD:return this.load_callback;case t.Operation.UNLOAD:return this.unload_callback;case t.Operation.TEARDOWN:return this.teardown_callback;default:throw new t.Error("Invalid action '"+n+"' given")}}.call(this);return p(o)?(i=o.bind(this.getContext()),i.length=o.length,i):function(){}},n.prototype.getContext=function(){var n;return n=this.context,n.parent=this.parent instanceof t.Node?this.parent.context:null,n},n.prototype.findCommonAncestor=function(n){var e,r,o,i,s,a,u,p,l;if(!(n instanceof t.Node))throw new t.Error("target_node must be an instanceof Finch.Node");for(r=[],o=this;o instanceof t.Node;)r.push(o),o=o.parent;for(s=[],o=n;o instanceof t.Node;)s.push(o),o=o.parent;for(a=0,p=r.length;p>a;a++)for(e=r[a],u=0,l=s.length;l>u;u++)if(i=s[u],e===i)return e;if(!(ancestor instanceof t.Node))throw new t.Error("Could not find common ancestor between '"+this.name+"' and '"+n.name+"'")},n.prototype.toString=function(){return this.name},n}(),t.NotFoundError=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return b(n,t),n.prototype.name="Finch.NotFoundError",n}(t.Error),t.Observer=function(){function n(n){if(!p(n))throw new t.Error("callback must be a Function");this.callback=n}return n.create=function(){var n,e,r,o;if(!(arguments.length>0))throw new t.Error("Invalid arguments given for creating an observer");if(p(arguments[0]))return new t.Observer(arguments[0]);if(s(arguments[0]))r=arguments[0],o=arguments[1];else{if(!f(arguments[0]))throw new t.Error("Invalid arguments given for creating an observer");r=Array.prototype.slice.call(arguments,0,arguments.length-1),o=arguments[arguments.length-1]}for(e in r)if(!f(e))throw new t.Error("requested parameters must be string values");if(!p(o))throw new t.Error("callback must be a function");return n=function(t){var n,i,s;for(n=[],i=0,s=r.length;s>i;i++)e=r[i],n.push(t(e));return o.apply(this,n)},new t.Observer(n)},n.prototype.callback=null,n.prototype.dependencies=null,n.prototype.is_disposed=!1,n.prototype.willMutate=function(t){var n,e,r;if(!c(t))return!1;if(!c(this.dependencies))return!0;r=this.dependencies;for(n in r)if(e=r[n],e!==t[n])return!0;return!1},n.prototype.notify=function(t){var n;return this.is_disposed?this:c(t)&&this.willMutate(t)?(n={},this.callback.call(this,function(e){return n[e]=t[e]}),this.dependencies=n,this):this},n.prototype.dispose=function(){return this.is_disposed=!0,this.dependencies=null,this.callback=null,this},n}(),t.Operation=function(){function n(n,r,o){var i,s,a,u;if(w.call(e,n)<0)throw new t.Error("Invalid action '"+n+"' given");if(!(r instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");this.action=n,this.node=r,u=null!=o?o:{},s=u.before_step,i=u.after_step,a=u.setup_params,this.before_step=p(s)?s:function(){},this.after_step=p(i)?i:function(){},this.setup_params=p(a)?a:function(){return{}}}var e;return n.SETUP="setup",n.LOAD="load",n.UNLOAD="unload",n.TEARDOWN="teardown",e=[n.SETUP,n.LOAD,n.UNLOAD,n.TEARDOWN],n.prototype.action=null,n.prototype.node=null,n.prototype.before_step=null,n.prototype.after_step=null,n.prototype.setup_params=null,n.prototype.execute=function(t,n){var e,r,o,i,s,a,u;return e=function(n){return function(){return n.after_step(n.action,n.node),p(t)?t(n.action,n.node):void 0}}(this),this.before_step(this.action,this.node),o=this.setup_params(this.action,this.node),c(o)||(o={}),s=null!=(a=null!=n?n.node:void 0)?a:null,i=null!=(u=null!=n?n.action:void 0)?u:null,r=this.node.getCallback(this.action,i,s),2===r.length?r(o,e):(r(o),e()),this},n}(),t.OperationQueue=function(){function n(t){var n,e;null==t&&(t={}),this.before_start=null!=(n=t.before_start)?n:function(){},this.after_finish=null!=(e=t.after_finish)?e:function(){},p(this.before_start)||(this.before_start=function(){}),p(this.after_finish)||(this.after_finish=function(){}),this.queue=[]}return n.prototype.queue=null,n.prototype.before_start=null,n.prototype.after_finish=null,n.prototype.is_executing=!1,n.prototype.appendOperation=function(n,e,r){var o;return o=new t.Operation(n,e,r),this.queue.push(o),o},n.prototype.execute=function(){var n,e;return this.is_executing?this:(this.is_executing=!0,this.before_start(),n=null,(e=function(r){return function(){var o;return o=n,n=r.queue.shift(),n instanceof t.Operation?n.execute(e,o):(r.after_finish(!1),r.is_executing=!1)}}(this))(),this)},n.prototype.abort=function(){return this.queue=[],this.after_finish(!0),this.before_start=function(){},this.after_finish=function(){},this.is_executing=!1,this},n}(),t.ParsedRouteString=function(){function n(n,e){if(!s(n))throw new t.Error("components must be an Array");s(e)||(e=[]),this.components=n,this.parent_components=e}return n.prototype.components=null,n.prototype.parent_components=null,n}(),t.Tree=function(){function n(){this.root_node=new t.Node("!"),this.root_node.is_endpoint=!0,this.load_path=new t.LoadPath}return n.prototype.root_node=null,n.prototype.load_path=null,n.prototype.parseRouteString=function(n){var e,o,i,s,a,u;if(!f(n))throw new t.Error("route_string must be a String");if(n=_(n),a=null,i=n.indexOf("["),e=n.indexOf("]"),o=i+e!==-2){if(i>0)throw new t.Error('Parsing failed on "'+n+'": [ not at beginning');if(-1===i)throw new t.Error('Parsing failed on "'+n+'": Missing [');if(r(n,"[")>1)throw new t.Error('Parsing failed on "'+n+'": Too many [');if(-1===i)throw new t.Error('Parsing failed on "'+n+'": Missing ]');if(r(n,"]")>1)throw new t.Error('Parsing failed on "'+n+'": Too many ]');a=n.slice(i+1,e),n=n.replace(/[\[\]]+/gi,"")}else a="!";return n=this.standardizeRouteString(n),u=this.createRouteComponents(n),a=this.standardizeRouteString(a),s=this.createRouteComponents(a),new t.ParsedRouteString(u,s)},n.prototype.extractRouteString=function(t){var n;return f(t)?_(null!=(n=t.split("?")[0])?n:""):""},n.prototype.extractQueryParameters=function(t){var n,e,r,o,i,s,a,u,p;if(!f(t))return{};if(o=t.split("?",2)[1],!f(o))return{};for(r={},u=o.split("&"),s=0,a=u.length;a>s;s++)e=u[s],p=e.split("=",2),n=p[0],i=p[1],r[n]=i;return r},n.prototype.standardizeRouteString=function(n){if(!f(n))throw new t.Error("route_string must be a String");return n=this.extractRouteString(n),"!"===n?n:(d(n,"/")&&(n="!"+n),d(n,"!")||(n="!/"+n),d(n,"!/")||(n="!/"+n.slice(1)),"!/"===n?n:(d(n,"!//")||(n="!//"+n.slice(2)),new RegExp(/^\!\/+$/).test(n)?n:g(n)))},n.prototype.createRouteComponents=function(t){var n,e;return f(t)?(e=t.split("/"),e=function(){var t,r,o;for(o=[],t=0,r=e.length;r>t;t++)n=e[t],o.push(_(n));return o}()):[]},n.prototype.addRoute=function(n){var e,r,o,i,s,a,u,p;if(a=this.parseRouteString(n),p=a.components,s=a.parent_components,"!"!==p[0])throw new t.Error("Routes must start with the root '!' node");if("!"!==s[0])throw new t.Error("Parent routes must start with the root '!' node");for(o=this.root_node,i=null,r=1;r<p.length;)u=p[r],r===s.length&&(i=o),e=o.findChildNode(u),e instanceof t.Node?o=e:(e=new t.Node(u),o.addChildNode(e),o=e),r++;return o.setParentNode(i),o.is_endpoint=!0,o},n.prototype.callRoute=function(n){var e,r,o;if(!f(n))throw new t.Error("route_string must be a String");return e=this.extractQueryParameters(n),n=this.standardizeRouteString(n),r=this.createRouteComponents(n),o=this.createLoadPath(r,e),this.load_path.traverseTo(o),this},n.prototype.createLoadPath=function(n,e){var r,o;if(!s(n))throw new t.Error("route_components must be an Array");if("!"!==n[0])throw new t.Error("Routes must start with the root '!' node");if(o=function(e){var r,i,s,a,u;return e.length>=n.length?e[e.length-1].is_endpoint?e:null:(s=e[e.length-1],i=n[e.length],r=s.findMatchingChildNode(i),r instanceof t.Node?(u=function(){var t,n,r;for(r=[],t=0,n=e.length;n>t;t++)a=e[t],r.push(a);return r}(),u.push(r),u=o(u),null!=u?u:(r=s.variable_child,r instanceof t.Node?(u=function(){var t,n,r;for(r=[],t=0,n=e.length;n>t;t++)a=e[t],r.push(a);return r}(),u.push(r),o(u)):null)):null)},r=o([this.root_node]),!s(r))throw new t.NotFoundError("Could not resolve the route '"+n.join("/")+"'");return new t.LoadPath(r,n,e)},n}(),t.UriManager=function(){function n(){}return n.is_listening=!1,n.getHash=function(){var t;return t=window.location.hash,"#"===t.charAt(0)&&(t=t.slice(1)),t},n.setHash=function(t){return f(t)||(t=""),t=_(t),"#"===t.charAt(0)&&(t=t.slice(1)),window.location.hash=t,this},n.parseQueryString=function(t){var n,e,r,o,i,s,a,u;if(!f(t))return{};for(r={},a=t.split("&"),i=0,s=a.length;s>i;i++)e=a[i],u=e.split("=",2),n=u[0],o=u[1],r[n]=o;return r},n.navigate=function(t,n,e){var r,o,i,s,u,p,l,h,g,m,y,b,w,v;if(c(t)&&(y=[t,n,null],n=y[0],e=y[1],t=y[2]),a(n)&&(b=[n,null],e=b[0],n=b[1]),w=this.getHash().split("?",2),s=w[0],i=w[1],o=this.parseQueryString(i),f(t)||(t=s),c(n)||(n={}),a(e)||(e=!1),t=_(t),"#"===t.charAt(0)&&(t=t.slice(1)),d(t,"./")||d(t,"../")){for(r=s;d(t,"./")||d(t,"../");)l=t.indexOf("/"),p=t.slice(0,l),t=t.slice(l+1),".."===p&&(r=r.slice(0,r.lastIndexOf("/")));t=t.length>0?""+r+"/"+t:r}v=t.split("?",2),t=v[0],g=v[1],h=this.parseQueryString(g);for(u in n)m=n[u],h[u]=m;if(n=h,e)for(u in o)m=o[u],u in n||(n[u]=m);for(u in n)m=n[u],null==m&&delete n[u];return t+="?"+function(){var t;t=[];for(u in n)m=n[u],t.push(""+u+"="+m);return t}().join("&"),this.setHash(t),this},n.listen_callback=null,n.listen_interval=null,n.listen=function(){var n;return this.is_listening?!0:(n=null,this.listen_callback=function(e){return function(){var r;return r=e.getHash(),r!==n?t.call(n):void 0}}(this),"onhashchange"in window&&(p(window.addEventListener)?(window.addEventListener("hashchange",this.listen_callback,!0),this.is_listening=!0):p(window.attachEvent)&&(window.attachEvent("hashchange",this.listen_callback),this.is_listening=!0)),this.is_listening||(this.listen_interval=setInterval(this.listen_callback,33),this.is_listening=!0),this.listen_callback(),this.is_listening)},n.ignore=function(){return this.is_listening?(null!==this.listen_interval?(clearInterval(this.listen_interval),this.listen_interval=null,this.is_listening=!1):"onhashchange"in window&&(p(window.removeEventListener)?(window.removeEventListener("hashchange",this.listen_callback,!0),this.is_listening=!1,this.listen_callback=null):p(window.detachEvent)&&(window.detachEvent("hashchange",this.listen_callback),this.is_listening=!1,this.listen_callback=null)),!this.is_listening):!0},n}(),i=new t,"undefined"!=typeof jasmine&&null!==jasmine&&(i.Tree=t.Tree,i.Node=t.Node,i.LoadPath=t.LoadPath,i.OperationQueue=t.OperationQueue,i.Operation=t.Operation,i.Error=t.Error,i.NotFoundError=t.NotFoundError,i.ParsedRouteString=t.ParsedRouteString),("undefined"!=typeof exports&&null!==exports?exports:this).Finch=i}).call(this);