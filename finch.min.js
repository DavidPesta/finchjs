/*
	Finch.js - Hierarchical Javascript Routing
	by Rick Allen (stoodder) and Greg Smith (smrq)

	Version 1.0.0
	Full source at https://github.com/stoodder/finchjs
	Copyright (c) 2014 RokkinCat, http://www.rokkincat.com

	MIT License, https://github.com/stoodder/finchjs/blob/master/LICENSE.md
*/
(function(){var t,n,e,r,o,i,a,u,s,c,p,h,l,f,d,_={}.hasOwnProperty,m=function(t,n){function e(){this.constructor=t}for(var r in n)_.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},F=[].indexOf||function(t){for(var n=0,e=this.length;e>n;n++)if(n in this&&this[n]===t)return n;return-1};n=function(t){var n,e,r,o,i;for(e={},o=0,i=t.length;i>o;o++)n=t[o],e[n]=!0;return function(){var t;t=[];for(n in e)r=e[n],t.push(n);return t}()},t=function(t,n){var e,r,i,a;if(!o(t))return[];for(o(n)||(n=[n]),r=0,a=n.length;a>r;r++)e=n[r],t=function(){var n,r,o;for(o=[],n=0,r=t.length;r>n;n++)i=t[n],i!==e&&o.push(i);return o}();return t},p=function(t){return null!=t&&"[object Object]"===Object.prototype.toString.call(t)},u=function(t){return null!=t&&"[object Function]"===Object.prototype.toString.call(t)},i=function(t){return null!=t&&"[object Boolean]"===Object.prototype.toString.call(t)},o=function(t){return null!=t&&"[object Array]"===Object.prototype.toString.call(t)},h=function(t){return null!=t&&"[object String]"===Object.prototype.toString.call(t)},c=function(t){return null!=t&&"[object Number]"===Object.prototype.toString.call(t)},s=function(t){return c(t)&&t!==t},a=function(t){var n,e;if(null==t)return!0;if(h(t))return 0===f(t).length;if(o(t))return 0===t.length;if(p(t)){for(n in t)return e=t[n],!1;return!0}return!1},f=String.prototype.trim?function(t){return String.prototype.trim.call(t)}:function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")},d=function(t){return t.replace(/^[\\/\s]+/,"").replace(/[\\/\s]+$/,"")},l=function(t,n){return 0===t.indexOf(n)},r=function(t,n){return t.lastIndexOf(n)===t.length-1},e=function(t,n){return t.split(n).length-1},this.Finch=new(function(){function t(){}return t.prototype.tree=null,t.prototype.route=function(t,n){var e;return null==this.tree&&(this.tree=new Finch.Tree),e=this.tree.addRoute(t),e.updateCallbacks(n),this},t.prototype.call=function(t){return this.tree instanceof Finch.Tree?(this.tree.callRoute(t),this):this},t.prototype.reload=function(){},t.prototype.peek=function(){},t.prototype.observe=function(){},t.prototype.abort=function(){},t.prototype.listen=function(){},t.prototype.ignore=function(){},t.prototype.navigate=function(){},t.prototype.reset=function(){},t.prototype.on=function(){},t.prototype.off=function(){},t.prototype.trigger=function(){},t}()),Finch.Error=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return m(n,t),n.prototype.name="Finch.Error",n.prototype.message=null,n.prototype.stack=function(){return n.__super__.stack.apply(this,arguments)},n.prototype.toString=function(){return""+this.name+": @{message}"},n}(Error),Finch.Console=new(function(){function t(){}return t.prototype.log=function(){},t.prototype.error=function(){},t.prototype.warn=function(){},t}()),Finch.LoadPath=function(){function t(t,n,e){var r,i,a,u,s;if(null==t&&(t=[]),null==n&&(n=[]),!o(t))throw new Finch.Error("nodes must be an Array");if(!o(n))throw new Finch.Error("route_components must be an Array");for(u=0,s=t.length;s>u;u++)if(i=t[u],!(i instanceof Finch.Node))throw new Finch.Error("nodes must be an instanceof Finch.Node");if(t.length!==n.length)throw new Finch.Error("nodes and route_components must have the same lengths");this.nodes=t,this.route_components=n,this.length=this.nodes.length,this.bindings={},p(e)||(e={}),this.params={};for(r in e)a=e[r],this.params[r]=a}return t.prototype.nodes=null,t.prototype.route_components=null,t.prototype.length=0,t.prototype.is_traversing=!1,t.prototype.current_operation_queue=null,t.prototype.bindings=null,t.prototype.params=null,t.prototype.push=function(t,n){var e;if(!(t instanceof Finch.Node))throw new Finch.Error("node must be an instanceof Finch.Node");if(!h(n))throw new Finch.Error("route_component must be a string");return this.nodes.push(t),this.route_components.push(n),this.length++,t.type===Finch.Node.VARIABLE&&(e=t.name.slice(1),this.bindings[e]=n),this},t.prototype.pushUntil=function(t,n){var e,r,o,i,a,u,s,c,p;if(!(t instanceof Finch.LoadPath))throw new Error("target_load_path must be an instanceof Finch.LoadPath");if(!(n instanceof Finch.Node))throw new Error("target_node must be an instanceof Finch.Node");if(e=this.length,r=t.indexFor(n)+1,e>=r)return this;for(a=t.nodes.slice(e,r),s=t.route_components.slice(e,r),o=c=0,p=a.length;p>c;o=++c)i=a[o],u=s[o],this.push(i,u);return this},t.prototype.pop=function(t){var n,e;return this.length>0?(t=this.nodes.pop(),e=this.route_components.pop(),this.length--,this.length<=0?this.bindings={}:t.type===Finch.Node.VARIABLE&&(n=t.name.slice(1),this.bindings[n]=void 0,delete this.bindings[n]),[t,e]):null},t.prototype.popUntil=function(t){if(!(null===t||t instanceof Finch.Node))throw new Finch.Error("target_node must be an instanceof Finch.Node");for(;this.length>0&&this.nodes[this.length-1]!==t;)this.pop();return this},t.prototype.indexFor=function(t){var n,e,r,o,i;if(!(t instanceof Finch.Node))return-1;for(i=this.nodes,n=r=0,o=i.length;o>r;n=++r)if(e=i[n],e===t)return n;return-1},t.prototype.nodeAt=function(t){return t>=0&&t<this.length?this.nodes[t]:null},t.prototype.prepareParams=function(t){var n,e,r,o,i;this.params=null!=t?t:this.params,e={},o=this.params;for(n in o)r=o[n],e[n]=r;i=this.bindings;for(n in i)r=i[n],e[n]=r;return e},t.prototype.traverseTo=function(t){var n,e,r,o,i;if(!(t instanceof Finch.LoadPath))throw new Finch.Error("target_load_path must be an instanceof Finch.LoadPath");if(this.current_operation_queue instanceof Finch.OperationQueue&&this.current_operation_queue.abort(),this.isEqual(t))return this;if(n=this.findCommonAncestor(t),o=this.nodeAt(this.length-1),r=t.nodeAt(t.length-1),this.current_operation_queue=new Finch.OperationQueue({before_start:function(t){return function(){return t.is_traversing=!0}}(this),after_finish:function(t){return function(){return t.is_traversing=!1,t.current_operation_queue=null}}(this)}),o instanceof Finch.Node&&r instanceof Finch.Node)if(o.parent===r.parent)this.current_operation_queue.appendOperation(Finch.Operation.UNLOAD,o,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(){return t.popUntil(n)}}(this)}),this.current_operation_queue.appendOperation(Finch.Operation.LOAD,r,{before_step:function(n){return function(){return n.pushUntil(t,r)}}(this),setup_params:function(n){return function(){return n.prepareParams(t.params)}}(this)});else{for(this.current_operation_queue.appendOperation(Finch.Operation.UNLOAD,o,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),e=o;e!==n;)this.current_operation_queue.appendOperation(Finch.Operation.TEARDOWN,e,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(n,e){return t.popUntil(e.parent)}}(this)}),e=e.parent;for(i=[],e=r;e instanceof Finch.Node&&e!==n;)i.push(e),e=e.parent;for(;e=i.pop();)this.current_operation_queue.appendOperation(Finch.Operation.SETUP,e,{before_step:function(n){return function(e,r){return n.pushUntil(t,r)}}(this),setup_params:function(n){return function(){return n.prepareParams(t.params)}}(this)});this.current_operation_queue.appendOperation(Finch.Operation.LOAD,r,{setup_params:function(n){return function(){return n.prepareParams(t.params)}}(this)})}else if(r instanceof Finch.Node){for(i=[],e=r;e instanceof Finch.Node&&e!==n;)i.push(e),e=e.parent;for(;e=i.pop();)this.current_operation_queue.appendOperation(Finch.Operation.SETUP,e,{before_step:function(n){return function(e,r){return n.pushUntil(t,r)}}(this),setup_params:function(n){return function(){return n.prepareParams(t.params)}}(this)});this.current_operation_queue.appendOperation(Finch.Operation.LOAD,r,{setup_params:function(n){return function(){return n.prepareParams(t.params)}}(this)})}else if(o instanceof Finch.Node)for(this.current_operation_queue.appendOperation(Finch.Operation.UNLOAD,o,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),e=o;e!==n;)this.current_operation_queue.appendOperation(Finch.Operation.TEARDOWN,e,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(n,e){return t.popUntil(e.parent)}}(this)}),e=e.parent;return this.current_operation_queue.execute(),this},t.prototype.findCommonAncestor=function(t){var n,e,r,o,i,a,u,s,c,p,h;if(!(t instanceof Finch.LoadPath))throw new Finch.Error("target_load_path must be an instanceof Finch.LoadPath");for(r=this.nodes[this.length-1],u=t.nodes[t.length-1],n=null,o=[];r instanceof Finch.Node;)o.unshift(r),r=r.parent;for(s=[];u instanceof Finch.Node;)s.unshift(u),u=u.parent;for(a=p=0,h=o.length;h>p;a=++p){if(r=o[a],u=s[a],r!==u)return n;if(e=this.indexFor(u),i=this.route_components.slice(0,e+1).join("/"),c=t.route_components.slice(0,e+1).join("/"),i!==c)return n;n=r}return n},t.prototype.isEqual=function(t){var n,e,r,o,i,a;if(!(t instanceof Finch.LoadPath))throw new Finch.Error("target_load_path must be an instanceof Finch.LoadPath");if(this.length!==t.length)return!1;for(a=this.route_components,n=o=0,i=a.length;i>o;n=++o)if(e=a[n],r=t.route_components[n],e!==r)return!1;return!0},t.prototype.toString=function(){var t,n,e,r;return e=this.route_components.join("/"),n=function(){var n,e;n=this.params,e=[];for(t in n)r=n[t],e.push(""+t+"="+r);return e}.call(this).join("&"),n.length>0&&(e+="?"+n),e},t}(),Finch.Node=function(){function t(t,n){this.name=t,this.type=Finch.Node.resolveType(this.name),this.parent=null!=n?n:null,this.params={}}var n,e;return t.LITERAL="literal",t.VARIABLE="variable",n=[t.LITERAL,t.VARIABLE],e=/^:[a-z0-9_-]+$/i,t.resolveType=function(t){return new RegExp(e).test(t)?Finch.Node.VARIABLE:Finch.Node.LITERAL},t.prototype.type=null,t.prototype.name=null,t.prototype.parent=null,t.prototype.params=null,t.prototype.literal_children=null,t.prototype.variable_child=null,t.prototype.setup_callback=null,t.prototype.load_callback=null,t.prototype.unload_callback=null,t.prototype.teardown_callback=null,t.prototype.addChildNode=function(t){if(!(t instanceof Finch.Node))throw new Finch.Error("node must be an instanceof Finch.Node");if(t.type===Finch.Node.VARIABLE)this.variable_child=t;else{if(null==this.literal_children&&(this.literal_children={}),this.literal_children[t.name])throw new Finch.Error("A node with the name '"+t.name+"' is already a child of the node '"+this.name+"'");this.literal_children[t.name]=t}return this},t.prototype.findChildNode=function(t){var n,e,r;if(!h(t))throw new Finch.Error("name must be a String");return e=Finch.Node.resolveType(t),n=e===Finch.Node.VARIABLE?this.variable_child:null!=(r=this.literal_children)?r[t]:void 0,null!=n?n:null},t.prototype.findMatchingChildNode=function(t){var n,e,r;if(!h(t))throw new Finch.Error("component must be a String");return null!=(n=null!=(e=null!=(r=this.literal_children)?r[t]:void 0)?e:this.variable_child)?n:null},t.prototype.setParentNode=function(t){if(!(null===t||t instanceof Finch.Node))throw new Finch.Error("node must be an instanceof Finch.Node");return this.parent=t,this},t.prototype.updateCallbacks=function(t){var n,e,r,o;return u(t)&&(r=t,o=!1,n=function(){return o=!1},e=function(t,n){return o?n():(o=!0,2===r.length?r.call(this,t,n):(r.call(this,t),n()))},t={setup:e,load:e,unload:n,teardown:n}),p(t)?(u(t.setup)&&(this.setup_callback=t.setup),u(t.load)&&(this.load_callback=t.load),u(t.unload)&&(this.unload_callback=t.unload),u(t.teardown)&&(this.teardown_callback=t.teardown),this):this},t.prototype.findCommonAncestor=function(t){var n,e,r,o,i,a,u,s,c;if(!(t instanceof Finch.Node))throw new Finch.Error("target_node must be an instanceof Finch.Node");for(e=[],r=this;r instanceof Finch.Node;)e.push(r),r=r.parent;for(i=[],r=t;r instanceof Finch.Node;)i.push(r),r=r.parent;for(a=0,s=e.length;s>a;a++)for(n=e[a],u=0,c=i.length;c>u;u++)if(o=i[u],n===o)return n;if(!(ancestor instanceof Finch.Node))throw new Finch.Error("Could not find common ancestor between '"+this.name+"' and '"+t.name+"'")},t}(),Finch.NotFoundError=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return m(n,t),n.prototype.name="Finch.NotFoundError",n}(Finch.Error),Finch.Operation=function(){function t(t,e,r){var o,i,a,s;if(F.call(n,t)<0)throw new Finch.Error("Invalid action '"+t+"' given");if(!(e instanceof Finch.Node))throw new Finch.Error("node must be an instanceof Finch.Node");this.action=t,this.node=e,s=null!=r?r:{},i=s.before_step,o=s.after_step,a=s.setup_params,this.before_step=u(i)?i:function(){},this.after_step=u(o)?o:function(){},this.setup_params=u(a)?a:function(){return{}}}var n;return t.SETUP="setup",t.LOAD="load",t.UNLOAD="unload",t.TEARDOWN="teardown",n=[t.SETUP,t.LOAD,t.UNLOAD,t.TEARDOWN],t.prototype.action=null,t.prototype.node=null,t.prototype.before_step=null,t.prototype.after_step=null,t.prototype.setup_params=null,t.prototype.execute=function(t){var n,e,r;return e=function(){switch(this.action){case Finch.Operation.SETUP:return this.node.setup_callback;case Finch.Operation.LOAD:return this.node.load_callback;case Finch.Operation.UNLOAD:return this.node.unload_callback;case Finch.Operation.TEARDOWN:return this.node.teardown_callback;default:return function(){}}}.call(this),u(e)||(e=function(){}),n=function(n){return function(){return n.after_step(n.action,n.node),u(t)?t(n.action,n.node):void 0}}(this),this.before_step(this.action,this.node),r=this.setup_params(this.action,this.node),p(r)||(r={}),2===e.length?e.call(this.node,r,n):(e.call(this.node,r),n()),this},t}(),Finch.OperationQueue=function(){function t(t){var n,e;null==t&&(t={}),this.before_start=null!=(n=t.before_start)?n:function(){},this.after_finish=null!=(e=t.after_finish)?e:function(){},u(this.before_start)||(this.before_start=function(){}),u(this.after_finish)||(this.after_finish=function(){})}return t.prototype.queue=[],t.prototype.before_start=null,t.prototype.after_finish=null,t.prototype.appendOperation=function(t,n,e){var r;return r=new Finch.Operation(t,n,e),this.queue.push(r),r},t.prototype.execute=function(){var t;return this.before_start(),(t=function(n){return function(){var e;return e=n.queue.shift(),e instanceof Finch.Operation?e.execute(t):n.after_finish(!1)}}(this))(),this},t.prototype.abort=function(){return this.queue=[],this.after_finish(!0),this.before_start=function(){},this.after_finish=function(){},this},t}(),Finch.ParsedRouteString=function(){function t(t,n){var e,r,i,a;if(!o(t))throw new Finch.Error("components must be an Array");for(o(n)||(n=[]),e=i=0,a=n.length;a>i;e=++i)if(r=n[e],t[e]!==r)throw new Finch.Error("Parent components does not match the components");this.components=t,this.parent_components=n}return t.prototype.components=null,t.prototype.parent_components=null,t}(),Finch.Tree=function(){function t(){this.root_node=new Finch.Node("!"),this.load_path=new Finch.LoadPath}return t.prototype.root_node=null,t.prototype.active_node=null,t.prototype.active_operation_queue=null,t.prototype.load_path=null,t.prototype.parseRouteString=function(t){var n,r,o,i,a,u;if(!h(t))throw new Finch.Error("route_string must be a String");if(t=f(t),a=null,o=t.indexOf("["),n=t.indexOf("]"),r=o+n!==-2){if(o>0)throw new Finch.Error('Parsing failed on "'+t+'": [ not at beginning');if(-1===o)throw new Finch.Error('Parsing failed on "'+t+'": Missing [');if(e(t,"[")>1)throw new Finch.Error('Parsing failed on "'+t+'": Too many [');if(-1===o)throw new Finch.Error('Parsing failed on "'+t+'": Missing ]');if(e(t,"]")>1)throw new Finch.Error('Parsing failed on "'+t+'": Too many ]');a=t.slice(o+1,n),t=t.replace(/[\[\]]+/gi,"")}else a="!";return t=this.extractRouteString(t),u=this.splitRouteString(t),a=this.extractRouteString(a),i=this.splitRouteString(a),new Finch.ParsedRouteString(u,i)},t.prototype.extractRouteString=function(t){return null==t?"!":(t=t.split("?")[0],t=f(t.toString()),t=d(t),0===t.length&&(t=""),l(t,"!")||(t="!/"+t),t)},t.prototype.extractQueryParameters=function(t){var n,e,r,o,i,a,u,s,c;if(!h(t))return{};if(o=t.split("?",2)[1],!h(o))return{};for(r={},s=o.split("&"),a=0,u=s.length;u>a;a++)e=s[a],c=e.split("=",2),n=c[0],i=c[1],r[n]=i;return r},t.prototype.splitRouteString=function(t){var n,e;return h(t)?(e=t.split("/"),e=function(){var t,r,o;for(o=[],t=0,r=e.length;r>t;t++)n=e[t],o.push(f(n));return o}()):[]},t.prototype.addRoute=function(t){var n,e,r,o,i,a,u,s;if(a=this.parseRouteString(t),s=a.components,i=a.parent_components,"!"!==s[0])throw new Finch.Error("Routes must start with the root '!' node");if("!"!==i[0])throw new Finch.Error("Parent routes must start with the root '!' node");for(r=this.root_node,o=null,e=1;e<s.length;)u=s[e],e===i.length&&(o=r),n=r.findChildNode(u),n instanceof Finch.Node?r=n:(n=new Finch.Node(u),r.addChildNode(n),r=n),e++;return r.setParentNode(o),r},t.prototype.callRoute=function(t){var n,e,r;if(!h(t))throw new Finch.Error("route_string must be a String");return n=this.extractQueryParameters(t),t=this.extractRouteString(t),e=this.splitRouteString(t),r=this.createLoadPath(e,n),this.load_path.traverseTo(r),this},t.prototype.createLoadPath=function(t,n){var e,r,i,a,u;if(!o(t))throw new Finch.Error("route_components must be an Array");if("!"!==t[0])throw new Finch.Error("Routes must start with the root '!' node");for(e=null,r=[],a=0,u=t.length;u>a;a++){if(i=t[a],e=e instanceof Finch.Node?e.findMatchingChildNode(i):this.root_node,!(e instanceof Finch.Node))throw new Finch.NotFoundError("Could not resolve the route '"+t.join("/")+"' at '"+i+"'");r.push(e)}return new Finch.LoadPath(r,t,n)},t}()}).call(this);