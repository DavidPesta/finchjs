/*
	Finch.js - Hierarchical Javascript Routing
	by Rick Allen (stoodder) and Greg Smith (smrq)

	Version 1.0.0
	Full source at https://github.com/stoodder/finchjs
	Copyright (c) 2014 RokkinCat, http://www.rokkincat.com

	MIT License, https://github.com/stoodder/finchjs/blob/master/LICENSE.md
*/
(function(){var t,e,n,r,o,i,s,a,u,p,l,h,c,f,d,_,g=[].slice,m={}.hasOwnProperty,y=function(t,e){function n(){this.constructor=t}for(var r in e)m.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},w=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};n=function(t){var e,n,r,o,i;for(n={},o=0,i=t.length;i>o;o++)e=t[o],n[e]=!0;return function(){var t;t=[];for(e in n)r=n[e],t.push(e);return t}()},e=function(t,e){var n,r,o,s;if(!i(t))return[];for(i(e)||(e=[e]),r=0,s=e.length;s>r;r++)n=e[r],t=function(){var e,r,i;for(i=[],e=0,r=t.length;r>e;e++)o=t[e],o!==n&&i.push(o);return i}();return t},h=function(t){return null!=t&&"[object Object]"===Object.prototype.toString.call(t)},u=function(t){return null!=t&&"[object Function]"===Object.prototype.toString.call(t)},s=function(t){return null!=t&&"[object Boolean]"===Object.prototype.toString.call(t)},i=function(t){return null!=t&&"[object Array]"===Object.prototype.toString.call(t)},c=function(t){return null!=t&&"[object String]"===Object.prototype.toString.call(t)},l=function(t){return null!=t&&"[object Number]"===Object.prototype.toString.call(t)},p=function(t){return l(t)&&t!==t},a=function(t){var e,n;if(null==t)return!0;if(c(t))return 0===d(t).length;if(i(t))return 0===t.length;if(h(t)){for(e in t)return n=t[e],!1;return!0}return!1},d=String.prototype.trim?function(t){return String.prototype.trim.call(t)}:function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")},_=function(t){return t.replace(/^[\\/\s]+/,"").replace(/[\\/\s]+$/,"")},f=function(t,e){return 0===t.indexOf(e)},o=function(t,e){return t.lastIndexOf(e)===t.length-1},r=function(t,e){return t.split(e).length-1},t=new(function(){function e(){}return e.prototype.tree=null,e.prototype.route=function(e,n){var r;return null==this.tree&&(this.tree=new t.Tree),r=this.tree.addRoute(e),r.setCallbacks(n),this},e.prototype.call=function(e){return null==this.tree&&(this.tree=new t.Tree),this.tree.callRoute(e),this},e.prototype.reload=function(){return null==this.tree&&(this.tree=new t.Tree),this.tree.load_path.reload(),this},e.prototype.peek=function(){return""},e.prototype.observe=function(){var e,n;return e=1<=arguments.length?g.call(arguments,0):[],n=function(t,e,n){n.prototype=t.prototype;var r=new n,o=t.apply(r,e);return Object(o)===o?o:r}(t.Observer.create,e,function(){}),null==this.tree&&(this.tree=new t.Tree),this.tree.load_path.addObserver(n),n},e.prototype.abort=function(){return null==this.tree&&(this.tree=new t.Tree),this.tree.load_path.abort(),this},e.prototype.listen=function(){return t.UriManager.listen()},e.prototype.ignore=function(){return t.UriManager.ignore()},e.prototype.navigate=function(e,n,r){return t.UriManager.navigate(e,n,r),this},e.prototype.reset=function(){return null==this.tree&&(this.tree=new t.Tree),this.tree.load_path.abort(),this.tree=new t.Tree,this},e.prototype.options=function(e,n){var r,o;if(h(e)){for(r in e)o=e[r],this.options(r,o);return this}switch(e){case"coerce_types":case"CoerceParameterTypes":null==this.tree&&(this.tree=new t.Tree),this.tree.load_path.coerce_types=n}return this},e.prototype.on=function(){},e.prototype.off=function(){},e.prototype.trigger=function(){},e}()),t.Error=function(){function t(t){this.message=t}return t.prototype.name="Finch.Error",t.prototype.event_name="error",t.prototype.message=null,t.prototype.toString=function(){return""+this.name+": "+this.message},t}(),t.LoadPath=function(){function e(e,n,r){var o,s,a,u,p;if(null==e&&(e=[]),null==n&&(n=[]),!i(e))throw new t.Error("nodes must be an Array");if(!i(n))throw new t.Error("route_components must be an Array");for(u=0,p=e.length;p>u;u++)if(s=e[u],!(s instanceof t.Node))throw new t.Error("nodes must be an instanceof Finch.Node");if(e.length!==n.length)throw new t.Error("nodes and route_components must have the same lengths");this.nodes=e,this.route_components=n,this.length=this.nodes.length,this.bindings={},this.observers=[],h(r)||(r={}),this.params={};for(o in r)a=r[o],this.params[o]=a}return e.prototype.nodes=null,e.prototype.route_components=null,e.prototype.length=0,e.prototype.is_traversing=!1,e.prototype.current_operation_queue=null,e.prototype.bindings=null,e.prototype.observers=null,e.prototype.params=null,e.prototype.coerce_types=!1,e.prototype.abort=function(){return this.current_operation_queue instanceof t.OperationQueue&&(this.current_operation_queue.abort(),this.current_operation_queue=null),this},e.prototype.push=function(e,n){var r;if(!(e instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");if(!c(n))throw new t.Error("route_component must be a string");return this.nodes.push(e),this.route_components.push(n),this.observers.push([]),this.length++,e.type===t.Node.VARIABLE&&(r=e.name.slice(1),this.bindings[r]=n),this},e.prototype.pushUntil=function(e,n){var r,o,i,s,a,u,p,l,h;if(!(e instanceof t.LoadPath))throw new Error("target_load_path must be an instanceof Finch.LoadPath");if(!(n instanceof t.Node))throw new Error("target_node must be an instanceof Finch.Node");if(r=this.length,o=e.indexFor(n)+1,r>=o)return this;for(a=e.nodes.slice(r,o),p=e.route_components.slice(r,o),i=l=0,h=a.length;h>l;i=++l)s=a[i],u=p[i],this.push(s,u);return this},e.prototype.pop=function(e){var n,r;return this.length>0?(e=this.nodes.pop(),r=this.route_components.pop(),this.observers.pop(),this.length--,this.length<=0?this.bindings={}:e.type===t.Node.VARIABLE&&(n=e.name.slice(1),this.bindings[n]=void 0,delete this.bindings[n]),[e,r]):null},e.prototype.popUntil=function(e){if(!(null===e||e instanceof t.Node))throw new t.Error("target_node must be an instanceof Finch.Node");for(;this.length>0&&this.nodes[this.length-1]!==e;)this.pop();return this},e.prototype.indexFor=function(e){var n,r,o,i,s;if(!(e instanceof t.Node))return-1;for(s=this.nodes,n=o=0,i=s.length;i>o;n=++o)if(r=s[n],r===e)return n;return-1},e.prototype.nodeAt=function(t){return t>=0&&t<this.length?this.nodes[t]:null},e.prototype.prepareParams=function(t){var e,n,r,o,i;this.params=null!=t?t:this.params,n={},o=this.params;for(e in o)r=o[e],n[e]=r;i=this.bindings;for(e in i)r=i[e],n[e]=r;return this.coerceObject(n)},e.prototype.coerceObject=function(t){var e,n,r;if(!this.coerce_types)return t;n={};for(e in t)r=t[e],n[e]="true"===r?!0:"false"===r?!1:/^[0-9]+$/.test(r)?parseInt(r):/^[0-9]+\.[0-9]*$/.test(r)?parseFloat(r):r;return n},e.prototype.createOperationQueue=function(){return new t.OperationQueue({before_start:function(t){return function(){return t.is_traversing=!0}}(this),after_finish:function(t){return function(e){return t.is_traversing=!1,t.current_operation_queue=null,e?void 0:t.notifyObservers()}}(this)})},e.prototype.reload=function(){var e;return this.length<=0?this:(e=this.nodeAt(this.length-1),null==this.current_operation_queue&&(this.current_operation_queue=this.createOperationQueue()),this.current_operation_queue.appendOperation(t.Operation.UNLOAD,e,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),this.current_operation_queue.appendOperation(t.Operation.LOAD,e,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),this.current_operation_queue.execute(),this)},e.prototype.traverseTo=function(e){var n,r,o,i,s;if(!(e instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");if(this.routesAreEqual(e))return this.paramsAreEqual(e)?this:(this.params=e.params,null!=this.current_operation_queue?this:(this.notifyObservers(),this));if(n=this.findCommonAncestor(e),i=this.nodeAt(this.length-1),o=e.nodeAt(e.length-1),null==this.current_operation_queue&&(this.current_operation_queue=this.createOperationQueue()),i instanceof t.Node&&o instanceof t.Node)if(i===o)this.current_operation_queue.appendOperation(t.Operation.UNLOAD,i,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),this.current_operation_queue.appendOperation(t.Operation.TEARDOWN,i,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(){return t.popUntil(n)}}(this)}),this.current_operation_queue.appendOperation(t.Operation.SETUP,o,{before_step:function(t){return function(){return t.pushUntil(e,o)}}(this),setup_params:function(t){return function(){return t.prepareParams(e.params)}}(this)}),this.current_operation_queue.appendOperation(t.Operation.LOAD,o,{setup_params:function(t){return function(){return t.prepareParams(e.params)}}(this)});else{for(this.current_operation_queue.appendOperation(t.Operation.UNLOAD,i,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),r=i;r!==n;)this.current_operation_queue.appendOperation(t.Operation.TEARDOWN,r,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(e,n){return t.popUntil(n.parent)}}(this)}),r=r.parent;for(s=[],r=o;r instanceof t.Node&&r!==n;)s.push(r),r=r.parent;for(;r=s.pop();)this.current_operation_queue.appendOperation(t.Operation.SETUP,r,{before_step:function(t){return function(n,r){return t.pushUntil(e,r)}}(this),setup_params:function(t){return function(){return t.prepareParams(e.params)}}(this)});this.current_operation_queue.appendOperation(t.Operation.LOAD,o,{setup_params:function(t){return function(){return t.prepareParams(e.params)}}(this)})}else if(o instanceof t.Node){for(s=[],r=o;r instanceof t.Node&&r!==n;)s.push(r),r=r.parent;for(;r=s.pop();)this.current_operation_queue.appendOperation(t.Operation.SETUP,r,{before_step:function(t){return function(n,r){return t.pushUntil(e,r)}}(this),setup_params:function(t){return function(){return t.prepareParams(e.params)}}(this)});this.current_operation_queue.appendOperation(t.Operation.LOAD,o,{setup_params:function(t){return function(){return t.prepareParams(e.params)}}(this)})}else if(i instanceof t.Node)for(this.current_operation_queue.appendOperation(t.Operation.UNLOAD,i,{setup_params:function(t){return function(){return t.prepareParams()}}(this)}),r=i;r!==n;)this.current_operation_queue.appendOperation(t.Operation.TEARDOWN,r,{setup_params:function(t){return function(){return t.prepareParams()}}(this),after_step:function(t){return function(e,n){return t.popUntil(n.parent)}}(this)}),r=r.parent;return this.current_operation_queue.execute(),this},e.prototype.findCommonAncestor=function(e){var n,r,o,i,s,a,u,p,l,h,c;if(!(e instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");for(o=this.nodes[this.length-1],u=e.nodes[e.length-1],n=null,i=[];o instanceof t.Node;)i.unshift(o),o=o.parent;for(p=[];u instanceof t.Node;)p.unshift(u),u=u.parent;for(a=h=0,c=i.length;c>h;a=++h){if(o=i[a],u=p[a],o!==u)return n;if(r=this.indexFor(u),s=this.route_components.slice(0,r+1).join("/"),l=e.route_components.slice(0,r+1).join("/"),s!==l)return n;n=o}return n},e.prototype.routesAreEqual=function(e){var n,r,o,i,s,a;if(!(e instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");if(this.length!==e.length)return!1;for(a=this.route_components,n=i=0,s=a.length;s>i;n=++i)if(r=a[n],o=e.route_components[n],r!==o)return!1;return!0},e.prototype.paramsAreEqual=function(e){var n,r,o,i,s,a,u,p;if(!(e instanceof t.LoadPath))throw new t.Error("target_load_path must be an instanceof Finch.LoadPath");r=0,a=this.params;for(n in a)s=a[n],r++;o=0,u=e.params;for(n in u)s=u[n],o++;if(r!==o)return!1;p=this.params;for(n in p){if(s=p[n],void 0===(i=e.params[n]))return!1;if(i!==s)return!1}return!0},e.prototype.addObserver=function(t){return this.length>0&&this.nodes[this.length-1].should_observe?(this.observers[this.length-1].push(t),t):t},e.prototype.notifyObservers=function(){var t,e,n,r,o,i,s,a,u;for(u=this.observers,t=o=0,s=u.length;s>o;t=++o){for(r=u[t],e=[],i=0,a=r.length;a>i;i++)n=r[i],n.is_disposed||(n.notify(this.coerceObject(this.params)),e.push(n));this.observers[t]=e}return this},e.prototype.toString=function(){var t,e,n,r;return n=this.route_components.join("/"),e=function(){var e,n;e=this.params,n=[];for(t in e)r=e[t],n.push(""+t+"="+r);return n}.call(this).join("&"),e.length>0&&(n+="?"+e),n},e}(),t.Node=function(){function e(e,n){this.name=e,this.type=t.Node.resolveType(this.name),this.parent=null!=n?n:null,this.params={},this.context={}}var n,r;return e.LITERAL="literal",e.VARIABLE="variable",n=[e.LITERAL,e.VARIABLE],r=/^:[a-z0-9_-]+$/i,e.resolveType=function(e){return new RegExp(r).test(e)?t.Node.VARIABLE:t.Node.LITERAL},e.prototype.type=null,e.prototype.name=null,e.prototype.parent=null,e.prototype.params=null,e.prototype.literal_children=null,e.prototype.variable_child=null,e.prototype.should_observe=!0,e.prototype.is_endpoint=!1,e.prototype.setup_callback=null,e.prototype.load_callback=null,e.prototype.unload_callback=null,e.prototype.teardown_callback=null,e.prototype.generalized_callback=null,e.prototype.addChildNode=function(e){if(!(e instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");if(e.type===t.Node.VARIABLE)this.variable_child=e;else{if(null==this.literal_children&&(this.literal_children={}),this.literal_children[e.name])throw new t.Error("A node with the name '"+e.name+"' is already a child of the node '"+this.name+"'");this.literal_children[e.name]=e}return this},e.prototype.findChildNode=function(e){var n,r,o;if(!c(e))throw new t.Error("name must be a String");return r=t.Node.resolveType(e),n=r===t.Node.VARIABLE?this.variable_child:null!=(o=this.literal_children)?o[e]:void 0,null!=n?n:null},e.prototype.findMatchingChildNode=function(e){var n,r,o;if(!c(e))throw new t.Error("component must be a String");return null!=(n=null!=(r=null!=(o=this.literal_children)?o[e]:void 0)?r:this.variable_child)?n:null},e.prototype.setParentNode=function(e){if(!(null===e||e instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");return this.parent=e,this},e.prototype.setCallbacks=function(t){return u(t)?(this.generalized_callback=t,this.setup_callback=this.load_callback=this.unload_callback=this.teardown_callback=null):h(t)&&(this.generalized_callback=null,this.setup_callback=u(t.setup)?t.setup:function(){},this.load_callback=u(t.load)?t.load:function(){},this.unload_callback=u(t.unload)?t.unload:function(){},this.teardown_callback=u(t.teardown)?t.teardown:function(){}),this},e.prototype.getCallback=function(e,n,r){var o,i;if(u(this.generalized_callback)){if(e===t.Operation.UNLOAD)return function(){};if(e===t.Operation.TEARDOWN)return function(){};if(n===t.Operation.SETUP&&r===this)return function(){};o=this.generalized_callback,this.should_observe=e===t.Operation.SETUP}else o=function(){switch(e){case t.Operation.SETUP:return this.setup_callback;case t.Operation.LOAD:return this.load_callback;case t.Operation.UNLOAD:return this.unload_callback;case t.Operation.TEARDOWN:return this.teardown_callback;default:throw new t.Error("Invalid action '"+e+"' given")}}.call(this);return u(o)?(i=o.bind(this.getContext()),i.length=o.length,i):function(){}},e.prototype.getContext=function(){var e;return e=this.context,e.parent=this.parent instanceof t.Node?this.parent.context:null,e},e.prototype.findCommonAncestor=function(e){var n,r,o,i,s,a,u,p,l;if(!(e instanceof t.Node))throw new t.Error("target_node must be an instanceof Finch.Node");for(r=[],o=this;o instanceof t.Node;)r.push(o),o=o.parent;for(s=[],o=e;o instanceof t.Node;)s.push(o),o=o.parent;for(a=0,p=r.length;p>a;a++)for(n=r[a],u=0,l=s.length;l>u;u++)if(i=s[u],n===i)return n;if(!(ancestor instanceof t.Node))throw new t.Error("Could not find common ancestor between '"+this.name+"' and '"+e.name+"'")},e.prototype.toString=function(){return this.name},e}(),t.NotFoundError=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e.prototype.name="Finch.NotFoundError",e.prototype.event_name="not_found",e}(t.Error),t.Observer=function(){function e(e){if(!u(e))throw new t.Error("callback must be a Function");this.callback=e}return e.create=function(){var e,n,r,o;if(!(arguments.length>0))throw new t.Error("Invalid arguments given for creating an observer");if(u(arguments[0]))return new t.Observer(arguments[0]);if(i(arguments[0]))r=arguments[0],o=arguments[1];else{if(!c(arguments[0]))throw new t.Error("Invalid arguments given for creating an observer");r=Array.prototype.slice.call(arguments,0,arguments.length-1),o=arguments[arguments.length-1]}for(n in r)if(!c(n))throw new t.Error("requested parameters must be string values");if(!u(o))throw new t.Error("callback must be a function");return e=function(t){var e,i,s;for(e=[],i=0,s=r.length;s>i;i++)n=r[i],e.push(t(n));return o.apply(this,e)},new t.Observer(e)},e.prototype.callback=null,e.prototype.dependencies=null,e.prototype.is_disposed=!1,e.prototype.willMutate=function(t){var e,n,r;if(!h(t))return!1;if(!h(this.dependencies))return!0;r=this.dependencies;for(e in r)if(n=r[e],n!==t[e])return!0;return!1},e.prototype.notify=function(t){var e;return this.is_disposed?this:h(t)&&this.willMutate(t)?(e={},this.callback.call(this,function(n){return e[n]=t[n]}),this.dependencies=e,this):this},e.prototype.dispose=function(){return this.is_disposed=!0,this.dependencies=null,this.callback=null,this},e}(),t.Operation=function(){function e(e,r,o){var i,s,a,p;if(w.call(n,e)<0)throw new t.Error("Invalid action '"+e+"' given");if(!(r instanceof t.Node))throw new t.Error("node must be an instanceof Finch.Node");this.action=e,this.node=r,p=null!=o?o:{},s=p.before_step,i=p.after_step,a=p.setup_params,this.before_step=u(s)?s:function(){},this.after_step=u(i)?i:function(){},this.setup_params=u(a)?a:function(){return{}}}var n;return e.SETUP="setup",e.LOAD="load",e.UNLOAD="unload",e.TEARDOWN="teardown",n=[e.SETUP,e.LOAD,e.UNLOAD,e.TEARDOWN],e.prototype.action=null,e.prototype.node=null,e.prototype.before_step=null,e.prototype.after_step=null,e.prototype.setup_params=null,e.prototype.execute=function(t,e){var n,r,o,i,s,a,p;return n=function(e){return function(){return e.after_step(e.action,e.node),u(t)?t(e.action,e.node):void 0}}(this),this.before_step(this.action,this.node),o=this.setup_params(this.action,this.node),h(o)||(o={}),s=null!=(a=null!=e?e.node:void 0)?a:null,i=null!=(p=null!=e?e.action:void 0)?p:null,r=this.node.getCallback(this.action,i,s),2===r.length?r(o,n):(r(o),n()),this},e}(),t.OperationQueue=function(){function e(t){var e,n;null==t&&(t={}),this.before_start=null!=(e=t.before_start)?e:function(){},this.after_finish=null!=(n=t.after_finish)?n:function(){},u(this.before_start)||(this.before_start=function(){}),u(this.after_finish)||(this.after_finish=function(){}),this.queue=[]}return e.prototype.queue=null,e.prototype.before_start=null,e.prototype.after_finish=null,e.prototype.is_executing=!1,e.prototype.appendOperation=function(e,n,r){var o;return o=new t.Operation(e,n,r),this.queue.push(o),o},e.prototype.execute=function(){var e,n;return this.is_executing?this:(this.is_executing=!0,this.before_start(),e=null,(n=function(r){return function(){var o;return o=e,e=r.queue.shift(),e instanceof t.Operation?e.execute(n,o):(r.after_finish(!1),r.is_executing=!1)}}(this))(),this)},e.prototype.abort=function(){return this.queue=[],this.after_finish(!0),this.before_start=function(){},this.after_finish=function(){},this.is_executing=!1,this},e}(),t.ParsedRouteString=function(){function e(e,n){if(!i(e))throw new t.Error("components must be an Array");i(n)||(n=[]),this.components=e,this.parent_components=n}return e.prototype.components=null,e.prototype.parent_components=null,e}(),t.Tree=function(){function e(){this.root_node=new t.Node("!"),this.root_node.is_endpoint=!0,this.load_path=new t.LoadPath}return e.prototype.root_node=null,e.prototype.load_path=null,e.prototype.parseRouteString=function(e){var n,o,i,s,a,u;if(!c(e))throw new t.Error("route_string must be a String");if(e=d(e),a=null,i=e.indexOf("["),n=e.indexOf("]"),o=i+n!==-2){if(i>0)throw new t.Error('Parsing failed on "'+e+'": [ not at beginning');if(-1===i)throw new t.Error('Parsing failed on "'+e+'": Missing [');if(r(e,"[")>1)throw new t.Error('Parsing failed on "'+e+'": Too many [');if(-1===i)throw new t.Error('Parsing failed on "'+e+'": Missing ]');if(r(e,"]")>1)throw new t.Error('Parsing failed on "'+e+'": Too many ]');a=e.slice(i+1,n),e=e.replace(/[\[\]]+/gi,"")}else a="!";return e=this.standardizeRouteString(e),u=this.createRouteComponents(e),a=this.standardizeRouteString(a),s=this.createRouteComponents(a),new t.ParsedRouteString(u,s)},e.prototype.standardizeRouteString=function(e){if(!c(e))throw new t.Error("route_string must be a String");return e=t.UriManager.extractRouteString(e),"!"===e?e:(f(e,"/")&&(e="!"+e),f(e,"!")||(e="!/"+e),f(e,"!/")||(e="!/"+e.slice(1)),"!/"===e?e:(f(e,"!//")||(e="!//"+e.slice(2)),new RegExp(/^\!\/+$/).test(e)?e:_(e)))},e.prototype.createRouteComponents=function(t){var e,n;return c(t)?(n=t.split("/"),n=function(){var t,r,o;for(o=[],t=0,r=n.length;r>t;t++)e=n[t],o.push(d(e));return o}()):[]},e.prototype.addRoute=function(e){var n,r,o,i,s,a,u,p;if(a=this.parseRouteString(e),p=a.components,s=a.parent_components,"!"!==p[0])throw new t.Error("Routes must start with the root '!' node");if("!"!==s[0])throw new t.Error("Parent routes must start with the root '!' node");for(o=this.root_node,i=null,r=1;r<p.length;)u=p[r],r===s.length&&(i=o),n=o.findChildNode(u),n instanceof t.Node?o=n:(n=new t.Node(u),o.addChildNode(n),o=n),r++;return o.setParentNode(i),o.is_endpoint=!0,o},e.prototype.callRoute=function(e){var n,r,o;if(!c(e))throw new t.Error("route_string must be a String");return n=t.UriManager.extractQueryParameters(e),e=this.standardizeRouteString(e),r=this.createRouteComponents(e),o=this.createLoadPath(r,n),this.load_path.traverseTo(o),this},e.prototype.createLoadPath=function(e,n){var r,o;if(!i(e))throw new t.Error("route_components must be an Array");if("!"!==e[0])throw new t.Error("Routes must start with the root '!' node");if(o=function(n){var r,i,s,a,u;return n.length>=e.length?n[n.length-1].is_endpoint?n:null:(s=n[n.length-1],i=e[n.length],r=s.findMatchingChildNode(i),r instanceof t.Node?(u=function(){var t,e,r;for(r=[],t=0,e=n.length;e>t;t++)a=n[t],r.push(a);return r}(),u.push(r),u=o(u),null!=u?u:(r=s.variable_child,r instanceof t.Node?(u=function(){var t,e,r;for(r=[],t=0,e=n.length;e>t;t++)a=n[t],r.push(a);return r}(),u.push(r),o(u)):null)):null)},r=o([this.root_node]),!i(r))throw new t.NotFoundError("Could not resolve the route '"+e.join("/")+"'");return new t.LoadPath(r,e,n)},e}(),t.UriManager=function(){function e(){}return e.is_listening=!1,e.getHash=function(){var t;return t=window.location.hash,"#"===t.charAt(0)&&(t=t.slice(1)),t},e.setHash=function(t){return c(t)||(t=""),t=d(t),"#"===t.charAt(0)&&(t=t.slice(1)),window.location.hash=t,this},e.parseQueryString=function(t){var e,n,r,o,i,s,a,u;if(!c(t))return{};for(r={},a=t.split("&"),i=0,s=a.length;s>i;i++)n=a[i],u=n.split("=",2),e=u[0],o=u[1],r[e]=o;return r},e.extractRouteString=function(t){var e;return c(t)?d(null!=(e=t.split("?")[0])?e:""):""},e.extractQueryParameters=function(t){return this.parseQueryString(t.split("?",2)[1])},e.navigate=function(t,e,n){var r,o,i,u,p,l,_,g,m,y,w,b,v,O,E;if(h(t)&&(b=[t,e,null],e=b[0],n=b[1],t=b[2]),s(e)&&(v=[e,null],n=v[0],e=v[1]),O=this.getHash().split("?",2),u=O[0],i=O[1],o=this.parseQueryString(i),c(t)||(t=u),h(e)||(e={}),s(n)||(n=!1),t=d(t),"#"===t.charAt(0)&&(t=t.slice(1)),f(t,"./")||f(t,"../")){for(r=u;f(t,"./")||f(t,"../");)g=t.indexOf("/"),l=t.slice(0,g),t=t.slice(g+1),".."===l&&(r=r.slice(0,r.lastIndexOf("/")));t=t.length>0?""+r+"/"+t:r}E=t.split("?",2),t=E[0],y=E[1],m=this.parseQueryString(y);for(p in e)w=e[p],m[p]=w;if(e=m,n)for(p in o)w=o[p],p in e||(e[p]=w);for(p in e)w=e[p],null==w&&delete e[p];return _=function(){var t;t=[];for(p in e)w=e[p],t.push(""+p+"="+w);return t}().join("&"),a(_)||(t+="?"+_),this.setHash(t),this},e.listen_callback=null,e.listen_interval=null,e.listen=function(){var e;return this.is_listening?!0:(e=null,this.listen_callback=function(n){return function(){var r;return r=n.getHash(),r!==e?t.call(e=r):void 0}}(this),"onhashchange"in window&&(u(window.addEventListener)?(window.addEventListener("hashchange",this.listen_callback,!0),this.is_listening=!0):u(window.attachEvent)&&(window.attachEvent("hashchange",this.listen_callback),this.is_listening=!0)),this.is_listening||(this.listen_interval=setInterval(this.listen_callback,33),this.is_listening=!0),this.listen_callback(),this.is_listening)},e.ignore=function(){return this.is_listening?(null!==this.listen_interval?(clearInterval(this.listen_interval),this.listen_interval=null,this.is_listening=!1):"onhashchange"in window&&(u(window.removeEventListener)?(window.removeEventListener("hashchange",this.listen_callback,!0),this.is_listening=!1,this.listen_callback=null):u(window.detachEvent)&&(window.detachEvent("hashchange",this.listen_callback),this.is_listening=!1,this.listen_callback=null)),!this.is_listening):!0},e}(),null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=t:null!=("undefined"!=typeof define&&null!==define?define.amd:void 0)&&u(define)?define(["Finch"],t):this.Finch=t}).call(this);